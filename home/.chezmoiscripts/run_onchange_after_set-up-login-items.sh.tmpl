#!/bin/bash

# set -eufo pipefail
set           \
  -o errexit  \
  -o nounset  \
  -o noglob   \
  -o pipefail

{{ if (and (eq .chezmoi.os "darwin") (not .ephemeral)) -}}


# Add Karabiner-Elements and Hammerspoon to Login Items
echo ""
echo "Adding Hammerspoon to Login Items..."

osascript <<EOF
tell application "System Events"
  make login item at end with properties {path:"/Applications/Hammerspoon.app", hidden:false}
end tell
EOF
echo "Hammerspoon added to Login Items."

# Check and request Accessibility permission for Hammerspoon
echo ""
echo "Checking Accessibility permission for Hammerspoon..."

# The TCC database check for Accessibility
while ! sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "SELECT client FROM access WHERE service='kTCCServiceAccessibility' AND client='org.hammerspoon.Hammerspoon' AND auth_value=2" 2>/dev/null | grep -q "org.hammerspoon.Hammerspoon"; do
  echo ""
  echo "Hammerspoon requires Accessibility permission to control your computer."
  echo "Opening System Settings > Privacy & Security > Accessibility..."
  open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
  echo ""
  echo "Please enable Accessibility for Hammerspoon,"
  echo "then press ENTER to continue..."
  read -r
done

echo "Hammerspoon Accessibility permission is configured."

{{- end }}
